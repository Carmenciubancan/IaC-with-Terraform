#!/usr/bin/env groovy

pipeline {   
  agent any
  tools {
    maven 'Maven'  // Use Maven tool configured in Jenkins
  }
  environment {
    IMAGE_NAME = 'missdocky/java-maven-app:1.0' // Docker image name with tag
  }
  stages {
    
    // STAGE 1: Build Java application into .jar file
    stage("build app") {
      steps {
        script {
          echo 'building application jar...'
          sh 'mvn package'  // Runs Maven build â†’ creates target/java-maven-app-1.0-SNAPSHOT.jar
        }
      }
    }
    
    // STAGE 2: Build Docker image and push to Docker Hub
    stage("build image") {
      environment {
        DOCKER_CREDS = credentials('docker-hub-repo')  // Docker Hub credentials from Jenkins
      }
      steps {
        script {
          echo 'building docker image...'
          sh "docker build -t ${IMAGE_NAME} ."
          
          echo 'logging into Docker Hub...'
          sh 'echo $DOCKER_CREDS_PSW | docker login -u $DOCKER_CREDS_USR --password-stdin'
          
          echo 'pushing image to Docker Hub...'
          sh "docker push ${IMAGE_NAME}"
        }
      }
    }
    
    // STAGE 3: Provision EC2 instance using Terraform
    stage("provision server") {
      environment {
        // AWS credentials from Jenkins
        AWS_ACCESS_KEY_ID = credentials('jenkins_aws_access_key_id')
        AWS_SECRET_ACCESS_KEY = credentials('jenkins-aws_secret_access_key')
        TF_VAR_env_prefix = 'test'  // Sets var.env_prefix = "test" for Terraform
      }
      steps {
        script {
          dir('terraform') {  // Navigate into terraform/ folder
            sh "terraform init"                    // Initialize Terraform
            sh "terraform apply --auto-approve"    // Provision EC2 (auto-approve = no confirmation)
            EC2_PUBLIC_IP = sh(                    // Capture EC2 public IP for next stage
              script: "terraform output ec2-public_ip",
              returnStdout: true
            ).trim()
          }
        }
      }
    }
    
    // STAGE 4: Deploy application to EC2 with Docker Compose
    stage("deploy") {
      environment {
        DOCKER_CREDS = credentials('docker-hub-repo')  // Docker Hub credentials
      }
      steps {
        script {
          echo "waiting for EC2 server to initialize"
          sleep(time: 90, unit: "SECONDS")  // Wait for EC2 to finish startup

          echo 'deploying docker image to EC2...'
          echo "${EC2_PUBLIC_IP}"
          
          // Command to run on EC2: server-cmds.sh with image name and Docker creds
          def shellCmd = "bash ./server-cmds.sh ${IMAGE_NAME} ${DOCKER_CREDS_USR} ${DOCKER_CREDS_PSW}"
          def ec2Instance = "ec2-user@${EC2_PUBLIC_IP}"

          // SSH into EC2 using saved SSH key
          sshagent(['server-ssh-key']) {
            sh "scp -o StrictHostKeyChecking=no server-cmds.sh ${ec2Instance}:/home/ec2-user"
            sh "scp -o StrictHostKeyChecking=no docker-compose.yaml ${ec2Instance}:/home/ec2-user"
            sh "ssh -o StrictHostKeyChecking=no ${ec2Instance} ${shellCmd}"
          }
        }
      }
    }               
  }
}